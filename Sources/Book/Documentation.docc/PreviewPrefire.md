# Preview & Prefire

<!--@START_MENU_TOKEN@-->Summary<!--@END_MENU_TOKEN@-->

## Overview

<!--@START_MENU_TOKEN@-->Text<!--@END_MENU_TOKEN@-->


## Главная проблема дизайн системы

Все строят дизайн-системы, чтобы можно было в одном месте поменять стиль кнопочки, а применилось ко всему проекту. Идеальная схема, в которой есть важная проблема:

Легко поменять компонент, но сложно проверить все места, на которые он повлиял. 

Вот Keynote понимает важность проблемы, но никак не помогает ее решить: я не вижу какие слайды и как изменятся!

Удивительно, что Фигма ничего не делает с этой стороны. Но разобраться можно на уровне кода через скриншот-тесты: если у вас есть живые снимки всех экранов, то при изменении стиля вы увидите все изменения, стоит лишь тесты запустить.

Ща разберемся как это быстро накрутить.

@Image(source: KeynoteAlert) {
    
}

### Быстрое покрытие половины проекта через превью

Подытожу пару прошлых постов:
⁃ Отделил зависимости проекта, их должно быть мало,
⁃ Написал офигенные стабы для них, легко использовать в любом месте проекта.
⁃ Подключил к превьюшкам.

Вроде в 2025 никому не надо доказывать пользу превьюшек, все кто работает со SwiftUI их использует, UIKit тоже давно можно подключать. Есть общение мнение, что работают они через раз, но ведь работают! 

Кратко плюсы от превью:
⁃ Можно отрисовать любой экран вашего проекта: не надо билдить все, кликать до нужного экрана и проверять
⁃ Быстрый фидбек: меняете код и видите результат.
⁃ Можно застабать этот экран в любое состояние: мало данных, много данных, нет данных и т.п.
⁃ Можно не билдить весь проект, а работать в отдельном модуле и собираться будет быстро

Ну т.е. очень похоже по описанию на результа, который мы хотим от автотестов, так? При этом каждая превьюшка это же конечное состояние, которое мы хотим не продолбать со временем. 

А можно ли из них всех собрать скриншот-тесты так, чтобы их не нужно было писать? Да, для этого есть пара библиотек: Prefier и SnapshotTesting от Emerge.

### Prefire

Prefire работает как плагин и во время билд-фазы проходит по коду, собирает превьюшки, кладет их в один файл и генерирует из них скриншот-тесты. Буквально: добавили плагин, запустили тесты, в репозитории появилось куча картинок. Можно немного поднастроить: добавить фреймворки в генерируемый класс, нужно, чтобы в превью была только одна верхнеуровневая вьюшка, нельзя использовать preview traits и прочая мелочь, но это все решаемо.

Зато импакт чумачечий:
⁃ Я добавил в свой проект и покрытие превратилось в 62%! Это вместе с тем, что превьюшки включают логику вьюмодели. 
⁃ Можно добавить дополнительных проверок: как оно будет в темной теме, как на Dynamic Type, что с описанием для скринридера и т.п.
•  ⁃ Можно сделать песочницу компонентов прямо в приложении, чтобы дизайнер мог понажимать на кнопочки.

@Image(source: SnapshotResults) {
    
}

> Note: Конечно, есть и минусы. Главный — файлы будут храниться картинками в вашем репозитории, его размер будет расти, поэтому стоит сразу настроить Git Large File Sys

### Snapshot Testing

Emerge пошли чуть дальше и сделали из такого подхода целый сервис. На стороне кода тоже самое: добавляете либу, она собирает превьюшки и выдает скриншот-тесты. Но важно то, где и как они хранятся: Emerge собирает их у себя на сервере и это дает ряд преимуществ:
⁃ Изменения от вашего кода считаются эталонными сразу и проверяются с бэком только на уровне пулл-реквеста. Там же вы сможете визуально сравнить что ПР изменяет и что нового привнес. 
⁃ Данные хранятся в облаке, поэтому вы можете просто открыть скриншот-тесты на любом компе. Другими словами — у дизайнера есть наглядный пример как его дизайн-система реально работает в приложении. 

Главный минус — это платный сервис, вроде как около тысячи долларов в год, но есть и более дешевые лицензии. 

@Image(source: SnapshotTestingDiff) {
 [Snapshots: Mobile snapshot testing like never before](https://youtu.be/JbPJRq1ZXm0?si=juQ2MznVRizjWQGE)    
}

### Автообновление скринштов на ПР
Можно вручную совместить подходы: хранить файлы в репозитории, но автообновлять на уровне пулл реквеста:
- Пушите код, тесты проходят
- Если скриншот-тест упал, то в ваш ПР предлагается новый ПР с обновленными картинками. 
- Вы принимаете решение обновить картинки или поменять код


Подробнее в статье. Она про Android, но суть и настройки CI это не особо меняет. 
["Playing with Compose Screenshot testing and Github Action" by Alexandre Bruneau](https://medium.com/@abruneau1993/playing-with-compose-screenshot-testing-and-github-action-632f31d0822b)

В итоге вот вам стратегия на начальное покрытие автотестами:
- контролируете зависимости,
- делаете превью,
- снепшотите превью.

Больше никаких отмазок, что бизнес не дает времени на тесты, оно само все получается!
