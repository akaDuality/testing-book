# Скорость разработки

Как тесты влияют на скорость разработки: они же очевидно должны помогать, но разработчики их почему-то не пишут.  

## Overview

Стоит только заговорить с разработчиками про тесты как появляется аргумент «мы стартап, делаем быстро, тесты писать некогда». И еще один: «мы — стартап, у нас все меняется, тесты только мешаются». И кажется, что все логично: чтобы написать тесты нужно дополнительное время, а значит, если их не писать, то мы очевидно выиграем. С другой стороны, так же очевидно, что начиная с какого-то уровня тесты писать все же стоит, потому что стало слишком уж сложно. 

## Где мы теряем в обычной разработке

Как выглядит обычная разработка:
- Пишем код
- Запускаем
- Проверяем результат
- Повторяем.

Но на самом деле на каждом этапе приходится превозмогать:
- Пишем код: сначала надо прочитать, понять все условия, аккуратно внести изменения.
- Запускаем: надо дождать билда приложения, потом запуска симулятора. 
- Проверяем результат: надо докликать до нужного экрана, повторить сценарий. Иногда сценарий сложный и повторять его прям лень. 
- Повторяем: этот цикл может проходить раз за разом даже для небольших изменений. 

Огромное ускорение дают SwiftUI-Preview и многим: для верстки достаточно изменить код и увидеть что получилось. И это отлично! Но еще:
- Хочется смотреть экраны во всех состояниях
- Хочется не проглядеть небольшие, но важные изменения
- Хочется так же легко работать и с логикой

Т.е. вот хочется же уметь управлять всем кодом, но тесты все равно почему-то не пишутся. Почему?

## Почему разработчики сами не пишут тесты

Тесты писать сложно, поэтому разработчики не умеют.

Чтобы эффективно работать через тесты нужно пройти несколько сложных подготовительных этапов:
- Изучить фреймворки тестирования. Для разных видов тестов есть разные фреймворки, поэтому учить приходится сразу много
- Отделить инфраструктуру от логики, т.е. написать код так, чтобы он был тестируем. 
- Для всех зависимостей написать такой код, который позволит управлять ими
- И только вот здесь мы начнем писать тест. 
- Будут попадаться сложные случаи. 

В итоге получается, что чтобы начать весь процесс нужен очень опытный разработчик, который поможет преодолеть эту сложность, а вот потом уже станет легче. 

@Comment {
    // TODO: Показать на графике как это влияет на сложность. 
}

## Как тесты ускоряют

Идеальная работа через тесты выглядит так:
- Мы берем лишь один сценарий приложения, который находится в отдельном модуле. Скомпилировать нужно лишь часть кода, поэтому билд будет очень быстрым. 
- Пишем короткий тесты который закрепляет нужное поведение. Тест пишется быстро, потому что у нас есть все нужные инструменты: стабы зависимостей, снепшот-стратегии, правильные логи, готовая архитектура. 
- Дописываем код, запускаем тесты, получаем готовый результат через секунды. 

Выглядит как идеальная схема: все максимально быстро, в фокусе, при этом остаются тесты, которые помогают в дальнейшей работе. 

## Как тесты замедляют

Минусы от тестов тоже есть: кода становится больше, а значит нужно поддерживать больший объем текста. Часто на красный тест непонятно какое из трех состояний мы имеем:
- Тест показал ошибку в коде
- Тест неправильно написан, но код работает правильно
- Все правильно написано, просто тест нестабильно работает и надо что-то иначе сделать. 

При этом у каждого типа тестов бывают свои проблемы:
- юнит-тесты были слишком близко к особенностям реализации и устарели
- интеграционные тесты упали непонятно по какой причине
- UI-тесты слишком долго идут, а когда упали непонятно кто виноват: тесты или код. 

## Преимущества в масштабе

### Самое непостоянное в проекте это люди
В моменты с тестами могут возникать разные сложности, но не смотря на это они помогают преодолеть главные проблемы больших проектов:
- Над проектом работают разные люди: они приходят и уходят или над одним местом работают разные люди по очереди
- Проект пишется долго, поэтому даже если над одним кодом работает один человек, то он все равно не вспомнит все требования спустя год после того как он этот код написал. 

Получается, что главная цель тестов — описать и сохранить все требования, которые наш код должен соблюдать. Коллектив разработчиков сможет пронести эти требования в изменяющихся условиях.

[Код без тестов — легаси](https://habr.com/ru/companies/dododev/articles/544110/)

### С тестами можно сделать больше

Другое важное свойство: если вы можете переложить часть работы на компьютер, то вы сами сможете выполнить более сложную работу. Например, даже для самой простой вьюшки есть десяток требований:
- она должна быть резиновой для разных размеров экрана и для разной длинны текста внутри,
- надо поддерживааь светлую и темную тему,
- сам размер текста может меняться, от чего верстка должна адаптироваться;
- еще и скринридер есть, который должен правильно зачитывать текст, а это вообще визуально не видно!

Можно запариться на одном экране и в уме держать все требования, но вот выполнить их равномерно для всего приложения — уже проблема. 

@Comment {
    // TODO: Расскзаать про изменения в базовых фреймворках. https://t.me/RubanovMobile/843
}

## Тесты мешают стартапам?

И вот возвращаясь к изначальной претензии, что «тесты стартапам не нужны»: тесты можно писать с первой строчки кода, для многих сценариев это самый быстрый способ получить ответ от системы, что-то проверить и т.п. Но в реальности мы часто сталкиваемся с тем, что команда писать тесты просто не умеет, а если в начале проекта попытается начать их писать, то команда потратит время *на свое обучение*, а не на движение вперед. 

При этом тесты никак стартапам не мешают, просто надо снизить требования к тестам, об этом будет в следующих главах. 

Задач, которым тесты очень хорошо помогают навалом: и верстка, и асинхронный код (одно лишь обновление аксес-токенов и разлогин от этого чего стоят) и ветвление в сценариях хорошо автоматизируются и убирают ручные проверки. 

## Эмоциональная часть

Даже спустя несколько лет постоянной практики в тестировании, разбора сотен кейсов и работы с десятками людей мне лень писать тесты. Причина довольная простая: мы не чувствуем, как тесты экономят время, но их поддержка ощущается как прямая потеря времени. У этого есть два интересных следствия.

### Тесты упрощают самые сложные задачи

В моменты такой фрустрации я оцениваю насколько сложно делать самую сложную задачу в проекте. В больших проектах чаще меняешь старый код, а не пишешь новый, и если тестов нет, то сталкиваешься с проблемами, которые к коду даже не относятся: 
- не знаешь всех требований к текущему коду, непонятно что отвалится после изменений и можно ли что-то удалить;
- разработчик, который знал, уволился несколько лет назад;
- код писали вы, но там чет так сложно было, что вы зарелизили и забили как страшный сон. 

Под давлением этих проблем код начинает умирать:
- новые разработчики под давлением сроков и сложности делают минимум работы, чтобы все успеть и ничего не сломать
- код превращается в лоскуты изменений, каждую следующую задачу сделать все сложнее. 

Так происходит еще и потому, что «сделать достаточно хорошо, чтобы зарелизить» намного проще, чем «сделать хорошо для будущей поддержки». Более того, если тестов нет, то от сложную задачу хочется скорее закончить и забыть, а вот сделать код лучше для нее просто страшно: что-то сломается, снова надо проверять вручную QA, это очевидно удлиняет задачу и про ваш рефакторинг в курсе все менеджеры. А если тесты могут подстраховать, то результат тестирования вы получаете раньше, процесс ускоряется, все довольны. 

> Tip: Если я чувствую, что любой код могу поменять и тесты подстрахуют, то все отлично.

### Проблемы внедрения

В Додо Пицце мы очень хотели начать писать тесты, потому что спустя 3 года развития проекта уже чувствовали проблемы отсутствия тестов. Мы пошли к продакт оунеру и он занял резонные вопросы:
- Сколько нам надо будет потратить времени на написание тестов? Очевидно, что время надо потратить, прям в процентах от времени разработки. 
- Что мы получим от написания тестов? Ну... какую-то экономию мы получим по времени, какие-то баги пораньше будут находится, регрессионное тестирование чуть быстрее будет, хотя их кейсы все равно надо проверять... А вот еще исследование есть из другой компании...

Минусы очевидно перевешивают плюсы и проект сложно продать. Но тут к нам зашел чумба на опыте и говорит:
- Кто чинит проблемы на проде, когда все упало? Разработчики. 
- Продакт оунер заходит на инцидент вообще? Лишь на самые крупные. 
- Понятно. Т.е. все риски на вас, но решения принимает тот, кто не рискует? Тогда он и не принимает решение. 

Ну мы решили перестать обсуждать и просто пойти писать тесты. 
- Спросил ли нас кто-то из менеджмента про тесты за пять лет? Ни разу: разработчики что-то там делают, пойди разберись из чего их работа состоит. 
- Получили ли явный прирост по качеству? В цифрах — скорее нет, разные баги как всплывали, так и продолжают, причин миллион разных. 
- Выросла ли скорость? Скорее не изменилась: затраты в одном месте компенсировались в другом. 

В чем плюсы тогда? Я вижу несколько:
- Местами было легко писать код для сложных случаев. Там, где обычный разработчик бы сдался и пошел упрощать задачу разработчик с тестами может пойти и решить как надо для пользователя или выдать более комплексное решение. Например, внедрение Dynamic Type было вообще возможно лишь благодаря тестам.  
- Легче масштабировать команду и поддерживать проект в долгосроке.
- Легче писать общий код: дизайн-систему, модуль платежей и т.п.
- Местами можно было писать прям плохой, но быстрый код, тесты страховали критические сценарии и подсвечивали недоработки. 

Иногда это было невероятным: например, я лично переписал карточку кастомизации комбо с одного контракта меню на другое за... 4 часа, полагаясь на результаты снепшот-тестов парсинга меню. Без тестов было даже непонятно как подступиться к задаче. Потом еще часов 20 дописывал тесты на разные корнер-кейсы, но изначальные тесты позволили смело править код и не слишком много держать в голове. 

@Comment {
    Оставить этот пример для главы про снепшот-тестирование 
}

> Tip: не спрашивайте бизнес писать тесты или нет. За провал долгосрочного развития будут отвечать разработчики. 

## Когда начинаем выигрывать от тестов

При любом раскладе получается так, что сначала надо в тесты вложиться, а уже потом вы получите от них пользу. По идее эта польза наступит тогда, когда у вас появятся первые баги (ну т.е. через неделю-две разработки), но совсем раскроется через 3-4 месяца, когда разработчику надо будет вернуться к коду, который он уже не помнит как написал.  

Конечно, все сильно зависит от задачи. Может быть ваша итория похожа на то, что было у команды Додо Пиццы когда они переделывали страницу оформления заказа и дошли до того, что [начали делать задачи по второму кругу](https://habr.com/ru/companies/dododev/articles/542636/), настолько тяжело было без тестов.  

### Мониторинг → Тесты

Важнейшая часть поддержки больших систем — воспроизводимость проблем. Первое что делает разработчик при исправлении бага — воспроизводит его, чтобы понять сценарий, затем причину проблемы, а в конце убедиться, что проблема решилась. Тесты упрощают этот сценарий: через аналитику можно понять действия пользователя, логи покажут поведение зависимостей, а значит можно воспроизвести проблему через тест и починить код. Оставшийся тест покажет, что с этой проблемой вы больше не сталкиваетесь. 

### Когда пора писать первый тест

Если вы написали код, а он заработал не так, как вы ожидали, то это значит, что задача перестала умещаться в вашей голове и пора все требования проверять автоматически. 

> Tip: Нашли баг — пишите тест, потому что вы уже один раз проиграли программированию.  

## Что делать то тогда?

- Контролировать зависимости
- Писать тесты когда можешь
- Смотреть что получается в итоге
