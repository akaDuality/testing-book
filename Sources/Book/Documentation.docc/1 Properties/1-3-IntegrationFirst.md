# Начните с тестов на сценарий

Как стоит подойти к «пирамиде тестирования» и почему тесты на сценарии самые важные. 

## Overview

Со свойствами тестов мы разобрались, поэтому посмотрим подробно на «тестирование через сценарии»: мы получаем, насколько это попадает под наши цели и какие преимущества у нас есть. 

### Скорость фидбека

Давайте выгрузим все способы получения обратной связи от нашего кода, от билда до релиза.  

@Image(source: FeedbackSpeed, alt: "Сводная таблица скорости фидбека")

Получается так, что мы можем сгруппировать их в 4 группы:
- Проверки на компьютере разработчика: автотесты, ручные проверки. 
- Отложенные на CI: полный прогон тестов, кодревью.
- Полностью ручные и отложенные: приемочное и исследовательское тестирование от QA
- Фидбек от пользователей: бета-тест, мониторинг, отзывы от пользователей. 

Если мы хотим обратную связь как можно раньше и как можно более дешевле, то выходит, что тестировать надо:
- автоматически на компьютере разработчика
- проверять как можно более высокие бизнес-требования

> Tip: начинай тестирование с бизнес-сценария. 

## Оно делает то, что надо

Если мы отталкиваемся от сценария пользователя, то мы буквально получаем бизнесовый ответ «наша программа делает то, что нам нужно. Примеры сценариев:
- Для регистрации человека в банке надо: ввести телефон, смс, ФИО, емейл, подтвердить его, показать лица, дождаться проверки, подписать соглашение и оповестить пользователя пушом.
- На старте приложения нужно обновить аксес-токен. В это время остальные запросы должны подождать, а если обновление не прошло, то пользователя надо разлогинить и стереть данные.
- При оформлении кредита в первый раз надо подписать договор, потом можно запроцессить транзакцию и показать успешный результат. 
- При пополнении денег через сторонний банк приложение получит диплинк, от которого мы должны обновить список транзакций и показать новую. 

@Comment {
    // TODO: Добавить примеров
}

Заметьте, здесь нет тестов в виде «презентер вызвал у интерактора метод ~`пукСреньк`~ `fooBar` 

> Tip: тестирование сценариев происходит через зависимости: интерфейс экрана, навигацию, сеть и т.п.

## Живучие!

У таких тестов будет главное свойство: они переживут большинство изменений в коде, потому что сам способ записи таких тестов будет оберткой поверх кода 

@Comment {
    // TODO: Написать про DSL
}

## Снепшот-тестирование контрактов

Из сценариев можно массово извлекать полезные свойства. Например, можно снять скриншот-тесты всех состояний экранов и показать дизайнеру. Или записать все события аналитики по сценарию и обсудить с аналитиком. Закрепить контракт, который обсудули с бэкендщиком. 

### Тесты это Excel

Код это разные абстракции поверх данных, программисты работают с абстрактными правилами. Интересно, что для обычных людей намного понятней Excel: там вообще минимум правил и формул, есть только пользовательские данные. В небольших масштабах людям данные важнее алгоритмов.

Но работать только с абстракциями сложно и программистам, всегда хочется опереться на входные и выходные данные, а это и есть тесты.   

> Тесты как Excel: выводят данные вперед алгоритмов. 

## Детализация только по-необходимости

Главная цель теста на сценарий — дойти до конца, выполнить целевое действие. Если что-то идет не по плану, то, скорее всего, ошибка обрабатывает на отдельном шаге:
- Не пришел код через СМС? Повтори запрос или введи другой номер телефона

@Comment {
    // TODO: Написать еще примеры
}

На такие сценарии можно уменьшить охват теста: не сценарий, а отдельный экран, не экран, а связку пары классов, не класс, а функцию. Но только когда это необходимо! Причем таких маленьких тестов уже может быть очень много, на самые разные состояния. 

## Модули приложения часто повторяют сценарии. 

Зачастую отдельный модуль приложения выполняет лишь 2-3 таких сценария, а все приложения собирается из сценариев разных модулей. На примере заказа пиццы:
- Нужно определить адрес человек, чтобы показать ему меню правильной пиццерии. Можно доставку или самовывоз, но в итоге то конкретная пиццерия будет выполнять заказ. 
- Из меню нужно добавить в корзину правильно настроенные продукты. Это может быть пицца, комбо, напиток, но все равно он ляжет в корзину с какими-то параметрами. 
- При оплате нужно получить деньги одним из способов. 




