# SnapshotTesting

Часто от тестирования хочется не столько проверить конечный результат, сколько заглянуть «под капот» кода и узнать а что там в итоге навызывалось. Например, вызов одной функции может вызвать несколько сетевых запросов или залогировать парочку событий аналитики с кучей данных. Данных может быть так много, что писать их внутри теста будет неудобно, а помочь сможет снепшот-тестирование. 

## Принцип работы

Идея простая: я не хочу описывать какой результат хочу, но я могу прогнать тест и пусть код сам запомнит что получилось. При последующих прогонах будем сравнивать результат с тем, что хранится в репозитории. Если вы поменяли код и прошлый снепшот вас не устраивает, то просто удалите его и сгенерируйте новый. 

Фактически для iOS работает как магия: вы пишите тест, вызываете ассерт снепшота и после прогона теста ваш код дописывается результатом вызова! При первом прогоне тест останется красным, потому что ему не с чем было сравнить результат, но если запустить еще раз, то результат работы кода сравнится с ожидаемым результатом. Если текст расходится, то вы увидите построчный diff между двумя блоками текста, так что разницу найти достаточно легко. 

@Comment {
    Показать на видео
}

Эталонный текст может храниться не в коде, а в отдельном файле рядом с тестами. Так чуть сложнее редактировать, но проще удалять все снепшоты за раз, например, если вы переписали сам формат снепшота данных.  

> Hint: в интернете такой подход можно найти под названием golden-master-тестирование, т.е. «сравнение с образцом» 

## Библиотека

Самая популярная библиотека на iOS от [Swift Snapshot Testing от Point-Free](https://github.com/pointfreeco/swift-snapshot-testing). В библиотеке есть встроенные стратегии для нескольких типов данных, можно снепшотить в файл или в код, легко расширяется собственными стратегиями тестирования и есть большое количество [других библиотек](https://github.com/pointfreeco/swift-snapshot-testing#plug-ins), которые опираются на нее, например, мы уже смотрели на <doc:PreviewPrefire>.  

## Дефолтные стратегии

Любой Codable-объект
```swift
assertSnapshot(of: user, as: .dump)
// ▿ User
//   - bio: "Blobbed around the world."
//   - id: 1
//   - name: "Blobby"

assertSnapshot(of: user, as: .json)
// {
//   "bio" : "Blobbed around the world.",
//   "id" : 1,
//   "name" : "Blobby"
// }
```

## Кастомные стратегии

@Comment {
    Добавить
}

## Снепшот-интерфейса

Подробнее про это в статье <doc:PreviewPrefire>

## Подход «снепшот всех контрактов» помогает коммуникациям в команде

Обычно результаты тестирования интересны только разработчикам, но вот снепшот-тесты позволяют упростить коммуникацию в команде:
- Снепшот сетевых запросов можно обсудить с бэкендщиком, чтобы отловить ошибку
- Скриншоты можно показать дизайнеру, чтобы сверить верстку с Figma
- Снепшот аналитики поверх сценария позволит аналитику лучше понять всех ли данных достаточно. 

Таким образом цикл разработки замыкается: команда договаривается о разных контрактах в начале задачи (API, дизайн, аналитика) и результаты работы приложения принимаются тоже в виде снепшотов этих контрактов.  
